version: 2.1

executors:
  node-executor:
    docker:
      - image: cimg/node:20.2.0
    working_directory: ~/project

jobs:
  run-e2e-tests:
    executor: node-executor
    parallelism: 4
    steps:
      - checkout

      - run:
          name: Install pnpm Locally
          command: npm install pnpm

      - run:
          name: Install Dependencies with pnpm
          command: ./node_modules/.bin/pnpm install

      - run:
          name: Debug Test Files
          command: |
            echo "Looking for test files in src/e2e/tests"
            TESTFILES=$(circleci tests glob "src/e2e/tests/*.spec.ts")
            if [ -z "$TESTFILES" ]; then
              echo "No test files found."
              exit 1
            else
              echo "Test files found:"
              echo "$TESTFILES"
            fi

      - run:
          name: Start Server and Run Tests
          command: |
            ./node_modules/.bin/pnpm run serve &  # Start the server in the background
            sleep 10  # Give the server time to start
            TESTFILES=$(circleci tests glob "src/e2e/tests/*.spec.ts" | circleci tests split)
            if [ -z "$TESTFILES" ]; then
              echo "No test files found."
              exit 1
            else
              echo "$TESTFILES" | xargs ./node_modules/.bin/pnpm playwright test --config=playwright.config.ci.ts --reporter=junit
            fi

      - store_test_results:
          path: test-results

workflows:
  version: 2
  run-test-workflow:
    jobs:
      - run-e2e-tests
